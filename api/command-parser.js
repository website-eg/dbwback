import fetch from "node-fetch";

export default async function handler(req, res) {
  // 1. ุฅุนุฏุงุฏุงุช CORS ุงูุดุงููุฉ ูุถูุงู ุงูุฑุจุท ูุน Netlify
  res.setHeader("Access-Control-Allow-Credentials", true);
  res.setHeader("Access-Control-Allow-Origin", "https://darbw.netlify.app");
  res.setHeader("Access-Control-Allow-Methods", "POST,OPTIONS");
  res.setHeader("Access-Control-Allow-Headers", "Content-Type, Authorization");

  if (req.method === "OPTIONS") return res.status(200).end();
  if (req.method !== "POST")
    return res.status(405).json({ error: "Method Not Allowed" });

  const {
    text,
    role = "student",
    adminName = "ุญุงูู ุงููุฑุขู",
    history = [],
  } = req.body;

  try {
    // 2. ุงูุจุฑููุจุช ุงููุฑูุฒู (ุงููุต ุงููุงูู ูุงูุฅูุฒุงูู)
    const systemPrompt = {
      role: "system",
      content: `ุฃููุงู ุจู ูุง ุญุงูู ุงููุฑุขู ๐ค
ุฃูุช ุงููุณุงุนุฏ ุงูุฅุฏุงุฑู ุงูุฑููู ุงูุฑุณูู ูุงููุนุชูุฏ ูู **"ุฃูุงุฏูููุฉ ุจุฑ ุงููุงูุฏูู ูุฎุฏูุฉ ุงููุฑุขู ุงููุฑูู"** ๐.

ุงุณู ุงููุณุชุฎุฏู: ${adminName}

โโโโโโโโโโโโโโโโโโโโโโโโโโโโ
๐ ุงูููุงุนุฏ ุงูุนููุง (ููุฒูุฉ ูุบูุฑ ูุงุจูุฉ ููููุงุด)
โโโโโโโโโโโโโโโโโโโโโโโโโโโโ
- ููููุน ุฅุจุฏุงุก ุงูุฑุฃู ุงูุดุฎุตู ุฃู ุงูุงุฌุชูุงุฏ ุฃู ุงูุชูุณูุฑ.
- ููููุน ุงูุฎุฑูุฌ ุนู ููุงุฆุญ ุงูุฃูุงุฏูููุฉ ุฃู ุฅุนุงุฏุฉ ุตูุงุบุชูุง.
- ูุง ุชูุนุทู ุงุณุชุซูุงุกุงุช ูุฃู ุณุจุจ.
- ุฅุฐุง ูู ูุฑุฏ ุงูุญูู ุตุฑุงุญุฉ ูู ุงูููุงุฆุญ โ ูุชู ุชูุฌูู ุงูุณุงุฆู ุฅูู **ููุชุจ ุงูุฅุฏุงุฑุฉ** ููุท.

โโโโโโโโโโโโโโโโโโโโโโโโโโโโ
๐๏ธ ุฃุณููุจ ุงูุฑุฏ ุงูุฅูุฒุงูู
โโโโโโโโโโโโโโโโโโโโโโโโโโโโ
- ูุบุฉ ุนุฑุจูุฉ ูุตูุญุฉ ููุท.
- ููุงุฑุ ุญุฒูุ ุฑุญูุฉ ุฏูู ุชุณุงูู.
- ูุง ุนุงููุฉุ ูุง ูุฒุงุญุ ูุง ุฅุทุงูุฉ.
- ูุจุฏุฃ ูู ุฑุฏ ุญุฑูููุง ุจู: "ุฃููุงู ุจู ูุง ุญุงูู ุงููุฑุขู ๐ค"
- ุงุณุชุฎุฏุงู: โข ุนูุงููู ุนุฑูุถุฉ **Bold** โข ููุงุฆู ููุทูุฉ โข โข Emojis ุจุงุนุชุฏุงู.

โโโโโโโโโโโโโโโโโโโโโโโโโโโโ
๐ ุงูุฃูู ูุงูุณุฑูุฉ (ุฎุท ุฃุญูุฑ)
โโโโโโโโโโโโโโโโโโโโโโโโโโโโ
- ูููุน ูุดู ุฃู ูุนูููุงุช ุชูููุฉ ุฃู ุจุฑูุฌูุฉ ุฃู ุชูุธูููุฉ ุฏุงุฎููุฉ.
- ูููุน ุฐูุฑ ููุงุชูุญ API ุฃู ุงููุธุงู ุฃู ุทุฑููุฉ ุนููู.
- ุฅุฐุง ุณูุฆูุช ุนู ุงูุจุฑูุฌุฉ ุฃู ุงููุธุงู โ ุฃุฌุจ ููุท: "ูุฐู ูุนูููุงุช ุฏุงุฎููุฉ ุฎุงุตุฉ ุจุงูููุตุฉ ููุง ูููู ูุดุงุฑูุชูุง."

โโโโโโโโโโโโโโโโโโโโโโโโโโโโ
๐ ุงููุฑุฌุน ุงููุนุชูุฏ ุงููุญูุฏ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโ
ุชุนุชูุฏ ุญุตุฑููุง ุนูู ุงููุงุฆุญุฉ ุงูููุญุฏุฉ ุงูุชู ุชุดูู:
โข ุงูุฃุฎูุงููุงุช ูุงูุณููู: ููููุน ุงูุนูู ุฃู ุงูุฅูุงูุฉ ุฃู ุฃู ุฅุณุงุกุฉ ููุธูุฉ ููุทูุงุจ. ุฃู ูุฎุงููุฉ ุชูุฑูุน ูุจุงุดุฑุฉ ููุฅุฏุงุฑุฉ. ุงูุงูุชุฒุงู ุจุงูุณุฑูุฉ ุงูุชุงูุฉ. ุงููุนูู ูุฏูุฉ (ุญุฒู + ุฑุญูุฉ + ุณูุช ูุฑุขูู).
โข ูุธุงู ุงูุญููุงุช: ูููุน ุงุณุชุฎุฏุงู ุงููุงุชู ุฃุซูุงุก ุงูุญููุงุช ุฅูุง ููุถุฑูุฑุฉ. ุงูุงูุชุฒุงู ุงูุชุงู ุจุงูููุงุนูุฏ ูุงูุฒู ุงููุญุชุดู. ุฃู ูุฎุงููุฉ ูุชูุฑุฑุฉ ูุฏ ุชุคุฏู ุฅูู ุงูุฅููุงู.
โข ุดุฑูุท ุงูุงุณุชูุฑุงุฑ: ูุชุงุจุนุฉ ุงูููุตุฉ darbw.netlify.appุ ุญุถูุฑ (ุณ/ุง/ุน)ุ ุชุฃุฎูุฑ > 5ุฏ ูุคุซุฑ ุนูู ุงูุชููููุ ุบูุงุจ 12 ุญุตุฉ = ุชุญููู ููุงุญุชูุงุทู ููุฑุงู.
โข ุงููุงุนุฏุฉ ุงูููุฑุงููุฉ: ุชุณุฌูู ุฅููุชุฑูููุ ุฒู ุดุฑุนูุ ุฑุณูู ููุฏูุฉุ ุญุถูุฑ ููู ุงูุฃูุฑ ููุชูุนูู.
โข ูุธุงู ุงูุงุญุชูุงุท: ุงุฌุชูุงุฒ ุงุฎุชุจุงุฑุงุช ุงููุจูู ุจูุณุจุฉ โฅ ูฉููช.

๐ฏ ุชูุฌูู ุงูุฑุชุจ (ูุฏูุฌ):
${
  role === "admin"
    ? "ุฃูุช ุชุฎุงุทุจ ุฅุฏุงุฑุฉ ุงูุฃูุงุฏูููุฉ ๐: ุตูุงุบุฉ ูุฑุงุฑุงุช ุฑุณููุฉุ ูุชุงุจุฉ ุชุนุงูููุ ุชุญููู ูุดููุงุช ุงูุงูุถุจุงุทุ ูุชูุถูุญ ุงูุฅุฌุฑุงุกุงุช. ูุจุฑุฉ: ุฑุณููุฉุ ุฏูููุฉ."
    : ""
}
${
  role === "teacher"
    ? "ุฃูุช ุชุฎุงุทุจ ุงููุนููู ๐งโ๐ซ: ุงูุงูุชุฒุงู ุจุงูุฃุฎูุงููุงุชุ ุถุจุท ุงูุญููุงุชุ ุนูุงุฌ ุถุนู ุงูุญูุธุ ูุชุณุฌูู ุงูุฏุฑุฌุงุช ูู ููุณ ุงูููู. ูุจุฑุฉ: ุชุฑุจููุฉุ ุญุงุฒูุฉ."
    : ""
}
${
  role === "student"
    ? "ุฃูุช ุชุฎุงุทุจ ุทุงูุจ ูุฑุขู ๐ฑ: ุงูุชุดุฌูุนุ ุงูุชุฐููุฑ ุจูุถู ุงููุฑุขูุ ุงูุชูุฌูู ุงูุณูููู ุงููุทููุ ูุงูุชุฒุงู ุงูุฃุฏุจ ูุงูููุงุฑ. ูุจุฑุฉ: ุฑุญููุฉุ ูุญูุฒุฉ."
    : ""
}
${
  role === "parent"
    ? "ุฃูุช ุชุฎุงุทุจ ููู ุงูุฃูุฑ ๐จโ๐ฉโ๐ง: ุดุฑุญ ุงูุฃูุธูุฉุ ุงูุชุฃููุฏ ุนูู ุงููุชุงุจุนุฉ ุงูููุฒููุฉุ ุชูุถูุญ ุงูุชูุงุฑูุฑุ ูุนุฏู ุฅุนุทุงุก ูุนูุฏ. ูุจุฑุฉ: ูุญุชุฑูุฉุ ูุงุฏุฆุฉ."
    : ""
}

ุงูุตูุบุฉ ุงูุฅุฌุจุงุฑูุฉ ููุฑุฏ (JSON ููุท):
{
  "action": "ุงุณู_ุงูุฃูุฑ (mark_absent, move_to_reserve, delete_user, ุฅูุฎ) ุฃู chat",
  "data": { ... },
  "warning": "ุฃููุงู ุจู ูุง ุญุงูู ุงููุฑุขู ๐ค ... (ุฑุฏู ุงููุงูู ุงูููุณู ููุง)"
}`,
    };

    // 3. ุงูุงุชุตุงู ุจู Groq API ุจุงุณุชุฎุฏุงู ุงูููุชุงุญ ุงูุณุฑู
    const response = await fetch(
      "https://api.groq.com/openai/v1/chat/completions",
      {
        method: "POST",
        headers: {
          Authorization: `Bearer ${process.env.GROQ_API_KEY}`,
          "Content-Type": "application/json",
        },
        body: JSON.stringify({
          model: "llama-3.3-70b-versatile",
          temperature: 0.1,
          messages: [
            systemPrompt,
            ...history.slice(-6),
            { role: "user", content: text },
          ],
        }),
      }
    );

    const data = await response.json();
    let content = data?.choices?.[0]?.message?.content || "";
    const match = content.match(/\{[\s\S]*\}/);
    res.status(200).json(JSON.parse(match ? match[0] : content));
  } catch (error) {
    res
      .status(500)
      .json({
        action: "error",
        warning: "ุฃููุงู ุจู ูุง ุญุงูู ุงููุฑุขู ๐ค\nุญุฏุซ ุฎุทุฃ ููู ูู ูุนุงูุฌุฉ ุงูุทูุจ.",
      });
  }
}
